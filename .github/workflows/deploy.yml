name: CDU-SNZH Backend CI/CD

on:
  push:
    branches: [ master, main ]
    paths:
      - 'cdu-snzh/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # 允许手动触发

jobs:
  build-and-deploy:
    name: 🚀 构建并部署蜀南竹海小程序后端
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v4
      
      - name: ☕ 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: 🔍 代码检查
        run: |
          cd cdu-snzh
          mvn checkstyle:check || echo "⚠️ Checkstyle检查有警告，继续构建..."
        continue-on-error: true
      
      - name: 🧪 运行测试
        run: |
          cd cdu-snzh
          mvn test || echo "⚠️ 测试有失败，继续构建..."
        continue-on-error: true
      
      - name: 🔨 Maven 打包
        run: |
          cd cdu-snzh
          echo "开始Maven打包..."
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Pprod
          echo "✅ Maven打包完成"
          ls -lh target/*.jar
      
      - name: 🔐 登录 DockerHub
        uses: docker/login-action@v3
        with:
          username: haibaraiii
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: 🐳 构建并推送 Docker 镜像
        run: |
          cd cdu-snzh
          
          # 构建镜像
          echo "开始构建 Docker 镜像..."
          docker build -t haibaraiii/cdu-snzh:latest .
          docker build -t haibaraiii/cdu-snzh:build-${{ github.run_number }} .
          
          # 推送到 DockerHub
          echo "推送镜像到 DockerHub..."
          docker push haibaraiii/cdu-snzh:latest
          docker push haibaraiii/cdu-snzh:build-${{ github.run_number }}
          
          echo "✅ Docker镜像已推送"
          echo "镜像标签: latest, build-${{ github.run_number }}"
      
      - name: 🚀 部署到生产服务器
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 8.156.75.132
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=========================================="
            echo "🔄 开始部署 CDU-SNZH 蜀南竹海小程序后端"
            echo "=========================================="
            
            # 拉取最新镜像
            echo "📦 拉取最新 Docker 镜像..."
            docker pull haibaraiii/cdu-snzh:latest
            
            # 停止旧容器
            echo "🛑 停止旧容器..."
            docker stop cdu-snzh-backend 2>/dev/null || echo "容器不存在或已停止"
            docker rm cdu-snzh-backend 2>/dev/null || echo "容器已删除"
            
            # 启动新容器
            echo "🚀 启动新容器..."
            docker run -d --name cdu-snzh-backend -p 8062:8062 -v /app/cdu-snzh/logs:/app/logs -e SPRING_PROFILES_ACTIVE=prod -e SPRING_DATASOURCE_URL="jdbc:mysql://8.156.75.132:3306/cdu_snzh?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false" -e SPRING_DATASOURCE_USERNAME=snzh -e SPRING_DATASOURCE_PASSWORD=Ww249260523.. -e SPRING_REDIS_HOST=8.156.75.132 -e SPRING_REDIS_PASSWORD=Ww249260523.. -e MINIO_ENDPOINT=http://8.156.75.132:9000 -e MINIO_ACCESS_KEY=haibara -e MINIO_SECRET_KEY=Ww249260523.. -e WECHAT_APPID=wxbc43db1ef4db8827 -e WECHAT_SECRET=03c8c9e86330e8ed7e0edae80d794756 -e WECHAT_MCHID=1561414331 -e WECHAT_MCH_SERIAL_NO=4B3B3DC35414AD50B1B755BAF8DE9CC7CF407606 -e WECHAT_API_V3_KEY=CZBK51236435wxpay435434323FFDuv3 -e WECHAT_NOTIFY_URL=https://www.weixin.qq.com/wxpay/pay.php -e WECHAT_REFUND_NOTIFY_URL=https://www.weixin.qq.com/wxpay/pay.php -e GAODE_MAP_KEY=dae1412666dc00d4f9660b4e558396b1 -e 'JWT_SECRET=ixXfr?;*bsFmHuF@tzYUAP.S.MT\=oq|cz3bm(+r(g!iW\3)'"'"'ba/RfqsU}=8+UWJ' -e AI_API_KEY=sk-156f588ab5a04ac0918bbb28bcdd7113 --restart unless-stopped --log-opt max-size=100m --log-opt max-file=5 haibaraiii/cdu-snzh:latest
            
            # 等待服务启动
            echo "⏳ 等待服务启动（15秒）..."
            sleep 15
            
            # 检查容器状态
            echo ""
            echo "📊 容器状态："
            if docker ps | grep -q cdu-snzh-backend; then
              echo "✅ 容器运行正常"
              docker ps | grep cdu-snzh-backend
            else
              echo "❌ 容器启动失败！查看日志："
              docker logs --tail 50 cdu-snzh-backend
              exit 1
            fi
            
            # 健康检查
            echo ""
            echo "🏥 执行健康检查..."
            for i in {1..10}; do
              if curl -f http://localhost:8062/actuator/health 2>/dev/null; then
                echo "✅ 服务健康检查通过"
                curl -s http://localhost:8062/actuator/health | python3 -m json.tool || true
                break
              fi
              echo "⏳ 等待服务就绪... ($i/10)"
              sleep 3
            done
            
            # 清理旧镜像
            echo ""
            echo "🧹 清理旧镜像..."
            docker image prune -f
            
            # 显示最后50行日志
            echo ""
            echo "📋 应用日志（最后50行）："
            docker logs --tail 50 cdu-snzh-backend
            
            echo ""
            echo "=========================================="
            echo "🎉 CDU-SNZH 后端部署完成！"
            echo "=========================================="
            echo "🔗 访问地址: http://8.156.75.132:8062"
            echo "📚 API文档: http://8.156.75.132:8062/doc.html"
            echo "🏥 健康检查: http://8.156.75.132:8062/actuator/health"
      
      - name: 📊 生成部署报告
        if: always()
        run: |
          echo "## 🚀 CDU-SNZH 后端部署报告" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 项目 | 信息 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| 📦 项目名称 | CDU-SNZH 蜀南竹海小程序后端 |" >> $GITHUB_STEP_SUMMARY
          echo "| 🏷️ 构建号 | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 🌿 分支 | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 👤 提交者 | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 📝 提交信息 | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 🐳 Docker镜像 | haibaraiii/cdu-snzh:latest |" >> $GITHUB_STEP_SUMMARY
          echo "| 🖥️ 服务器 | 8.156.75.132:8062 |" >> $GITHUB_STEP_SUMMARY
          echo "| ⏰ 部署时间 | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "| 📊 状态 | ${{ job.status == 'success' && '✅ 成功' || '❌ 失败' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔗 快速链接" >> $GITHUB_STEP_SUMMARY
          echo "- [API文档](http://8.156.75.132:8062/doc.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [健康检查](http://8.156.75.132:8062/actuator/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [DockerHub](https://hub.docker.com/r/haibaraiii/cdu-snzh)" >> $GITHUB_STEP_SUMMARY
      
      - name: 📢 部署成功通知
        if: success()
        run: |
          echo "::notice title=部署成功::✅ CDU-SNZH 蜀南竹海小程序后端已成功部署到生产环境（构建 #${{ github.run_number }}）"
      
      - name: 📢 部署失败通知
        if: failure()
        run: |
          echo "::error title=部署失败::❌ CDU-SNZH 蜀南竹海小程序后端部署失败，请检查日志"

